{% extends 'layout.html' %}

{% block title %}ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚ & Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·{% endblock %}

{% block content %}
<h1 class="mb-4">ğŸ“‹ Î£ÏÏƒÏ„Î·Î¼Î± Î£Ï‡Î¿Î»Î¹ÎºÏÎ½ Î‘Î½Î±Ï†Î¿ÏÏÎ½</h1>

<div id="reports" class="mb-5">
    <h2 class="border-bottom pb-2 mb-4">Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚ Î‘Î½Î¬ ÎœÎ®Î½Î±</h2>

    <div class="d-flex flex-wrap gap-2 mb-4">
    <label for="filterStudent" class="form-label mb-0 align-self-center">Î¦Î¯Î»Ï„ÏÎ±:</label>
    <select class="form-select w-auto" id="filterStudent">
        <option value="">ÎŒÎ»Î¿Î¹ Î¿Î¹ ÎœÎ±Î¸Î·Ï„Î­Ï‚</option>
        {% for student in students %}
            <option value="{{ student.id }}">{{ student.section.name }} - {{ student.name }}</option>
        {% endfor %}
    </select>
    <select class="form-select w-auto" id="filterCourse">
        <option value="">ÎŒÎ»Î± Ï„Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</option>
        {% for course in courses %}
            <option value="{{ course.id }}">{{ course.name }}</option>
        {% endfor %}
    </select>
    <select class="form-select w-auto" id="filterMonth">
        <option value="">ÎŒÎ»Î¿Î¹ Î¿Î¹ ÎœÎ®Î½ÎµÏ‚</option>
        {% for month in months %}
            <option value="{{ month }}">{{ month }}</option>
        {% endfor %}
    </select>
    
    <button type="button" id="printReportsBtn" class="btn btn-dark" disabled>
        ğŸ–¨ï¸ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î‘Î½Î±Ï†Î¿ÏÏÎ½ (ÎœÎ±Î¸Î·Ï„Î®Ï‚ & ÎœÎ®Î½Î±Ï‚)
    </button>
    </div>

    {% if reports %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="reports-list">
            {% for report in reports %}
                <div class="col report-item" 
                     data-student="{{ report.student_id }}" 
                     data-course="{{ report.course_id }}"
                     data-month="{{ report.report_month }}">
                    <div class="card report-card h-100 shadow-sm">
                        <div class="card-header bg-light">
                            <span class="badge bg-primary me-2">{{ report.student.section.name }}</span>
                            <strong class="text-primary">{{ report.student.name }}</strong>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ report.course.name }} <small class="text-muted float-end">{{ report.report_month }}</small></h5>
                            <p class="card-text text-truncate-multiline mb-2 report-text-snippet btn-toggle-report" data-report-id="{{ report.id }}">
                                {{ report.report_text }}
                            </p>
                            <div class="full-report-text d-none" id="full-report-{{ report.id }}">
                                <p class="card-text">{{ report.report_text }}</p>
                                <p class="small text-muted mb-1"><strong>ÎšÎ±Î¸Î·Î³Î·Ï„Î®Ï‚:</strong> {{ report.teacher_name }}</p>
                                <p class="small text-muted">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®: {{ report.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <a href="{{ url_for('edit_report', report_id=report.id) }}" class="btn btn-sm btn-outline-info">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</a>
                            <form method="POST" action="{{ url_for('delete_report', report_id=report.id) }}" onsubmit="return confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Î±Î½Î±Ï†Î¿ÏÎ¬;')">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="alert alert-info">Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¸ÎµÎ¯ Î±Î½Î±Ï†Î¿ÏÎ­Ï‚ Î±ÎºÏŒÎ¼Î±. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Î¼Î¯Î± Ï„ÏÏÎ±!</p>
    {% endif %}
</div>


<div id="management" class="mb-5 pt-4 border-top">
    <h2 class="border-bottom pb-2 mb-4">ğŸ”§ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎœÎ±Î¸Î·Ï„ÏÎ½, Î¤Î¼Î·Î¼Î¬Ï„Ï‰Î½ & ÎœÎ±Î¸Î·Î¼Î¬Ï„Ï‰Î½</h2>
    <div class="row">
        
        <div class="col-lg-4 mb-4">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white">
                    <h5>ğŸ‘¥ ÎœÎ±Î¸Î·Ï„Î­Ï‚</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_student') }}" class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" name="student_name" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î¸Î·Ï„Î®" required>
                            <select class="form-select" name="section_id" required>
                                <option value="" disabled selected>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¤Î¼Î®Î¼Î±</option>
                                {% for section in sections %}
                                    <option value="{{ section.id }}">{{ section.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-success" type="submit">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                        </div>
                    </form>
                    <ul class="list-group list-group-flush" id="student-list">
                        {% for student in students %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ student.id }}" data-section-id="{{ student.section_id }}" data-type="student">
                                <div>
                                    <span class="badge bg-primary me-2">{{ student.section.name }}</span>
                                    <span class="entity-name" data-name-type="student-name">{{ student.name }}</span>
                                </div>
                                <span class="text-muted small">ID: {{ student.id }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card h-100 border-info">
                <div class="card-header bg-info text-white">
                    <h5>ğŸ“š ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_course') }}" class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" name="course_name" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚ (Ï€.Ï‡. Î¦Ï…ÏƒÎ¹ÎºÎ®)" required>
                            <button class="btn btn-info" type="submit">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                        </div>
                    </form>
                    <ul class="list-group list-group-flush" id="course-list">
                        {% for course in courses %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ course.id }}" data-type="course">
                                <span class="entity-name">{{ course.name }}</span>
                                <span class="text-muted small">ID: {{ course.id }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card h-100 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5>ğŸ·ï¸ Î¤Î¼Î®Î¼Î±Ï„Î±</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_section') }}" class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" name="section_name" placeholder="ÎŒÎ½Î¿Î¼Î± Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚ (Ï€.Ï‡. Î“3)" required>
                            <button class="btn btn-warning" type="submit">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                        </div>
                    </form>
                    <ul class="list-group list-group-flush" id="section-list">
                        {% for section in sections %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ section.id }}" data-type="section">
                                <span class="entity-name">{{ section.name }}</span>
                                <span class="text-muted small">ID: {{ section.id }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm" method="POST" action="{{ url_for('edit_data') }}">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editModalLabel">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="entity_type" id="modal-entity-type">
                    <input type="hidden" name="entity_id" id="modal-entity-id">

                    <div class="mb-3">
                        <label for="modal-new-name" class="form-label">ÎÎ­Î¿ ÎŒÎ½Î¿Î¼Î±</label>
                        <input type="text" class="form-control" name="new_name" id="modal-new-name" required>
                        <small class="form-text text-muted">
                            <span id="name-type-info"></span>
                        </small>
                    </div>

                    <div class="mb-3" id="student-section-select">
                        <label for="modal-new-section" class="form-label">ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ ÏƒÎµ Î¤Î¼Î®Î¼Î±</label>
                        <select class="form-select" name="new_section_id" id="modal-new-section">
                            <option value="">(Î”Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚)</option>
                            {% for section in sections %}
                                <option value="{{ section.id }}">{{ section.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                    <button type="submit" class="btn btn-primary">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î‘Î»Î»Î±Î³ÏÎ½</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
    // 1. Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î¦Î¯Î»Ï„ÏÏ‰Î½ & Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎšÎ¿Ï…Î¼Ï€Î¹Î¿Ï Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚
    function applyFilters() {
        const studentId = $('#filterStudent').val();
        const courseId = $('#filterCourse').val();
        const month = $('#filterMonth').val();
        const printBtn = $('#printReportsBtn');

        // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·/Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï… ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚
        if (studentId && month) {
            printBtn.prop('disabled', false).removeClass('btn-dark').addClass('btn-primary');
        } else {
            printBtn.prop('disabled', true).removeClass('btn-primary').addClass('btn-dark');
        }

        // Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± ÎºÎ±ÏÏ„ÏÎ½
        $('#reports-list .report-item').each(function() {
            const itemStudent = $(this).data('student').toString();
            const itemCourse = $(this).data('course').toString();
            const itemMonth = $(this).data('month');

            const matchStudent = !studentId || itemStudent === studentId;
            const matchCourse = !courseId || itemCourse === courseId;
            const matchMonth = !month || itemMonth === month;

            if (matchStudent && matchCourse && matchMonth) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    $('#filterStudent, #filterCourse, #filterMonth').on('change', applyFilters);
    
    // 4. Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚
    $('#printReportsBtn').on('click', function() {
        const studentId = $('#filterStudent').val();
        const month = $('#filterMonth').val();

        if (studentId && month) {
            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± URL Î³Î¹Î± Ï„Î· Î½Î­Î± route ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚
            const url = `{{ url_for('print_reports') }}?student_id=${studentId}&month=${month}`;
            // Î‘Î½Î¿Î¯Î³ÎµÎ¹ ÏƒÎµ Î½Î­Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ· (Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î· route /print_reports ÏƒÏ„Î¿ app.py)
            window.open(url, '_blank'); 
        } else {
            alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ ÎœÎ±Î¸Î·Ï„Î® ÎºÎ±Î¹ ÎœÎ®Î½Î± Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·.');
        }
    });
    
    // 2. Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Toggle ÎšÎµÎ¹Î¼Î­Î½Î¿Ï… Î‘Î½Î±Ï†Î¿ÏÎ¬Ï‚
    $('.btn-toggle-report').on('click', function() {
        const reportId = $(this).data('report-id');
        const snippet = $(this);
        const fullText = $('#full-report-' + reportId);

        snippet.toggleClass('d-none');
        fullText.toggleClass('d-none');
    });

    // 3. Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Inline Editing (ÎœÎ±Î¸Î·Ï„Î­Ï‚, ÎœÎ±Î¸Î®Î¼Î±Ï„Î±, Î¤Î¼Î®Î¼Î±Ï„Î±)
    $('.entity-name').on('click', function() {
        const listItem = $(this).closest('li');
        const entityType = listItem.data('type');
        const entityId = listItem.data('id');
        const currentName = $(this).text();
        const currentSectionId = listItem.data('section-id');

        $('#modal-entity-type').val(entityType);
        $('#modal-entity-id').val(entityId);
        $('#modal-new-name').val(currentName);
        $('#editModalLabel').text('Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ' + (entityType === 'student' ? 'ÎœÎ±Î¸Î·Ï„Î®' : entityType === 'course' ? 'ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚' : 'Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚'));
        
        // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ·/Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· Ï€ÎµÎ´Î¯Î¿Ï… Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚ Î³Î¹Î± Ï„Î¿Î½ Î¼Î±Î¸Î·Ï„Î®
        if (entityType === 'student') {
            $('#student-section-select').show();
            $('#modal-new-section').val(currentSectionId);
            $('#name-type-info').text('Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î‘Î»Î»Î¬Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î¿ ÏŒÎ½Î¿Î¼Î±, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¼Î¿Î½Î±Î´Î¹ÎºÏŒ.');
        } else {
            $('#student-section-select').hide();
            $('#name-type-info').text('Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¼Î¿Î½Î±Î´Î¹ÎºÏŒ.');
        }

        var editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.show();
    });
</script>
{% endblock %}